<div class="thread-container">
    <div class="thread-header">
        <div>Thread
            <span style="font-family: Nunito; font-size: 14px; font-weight: 400; color: rgba(121, 126, 243, 1);">
                #{{channelName}}
            </span>
        </div>
        <img src="./assets/icons/close.png" alt="Close Thread" (click)="closeThread()">
    </div>

    <div class="thread-content" [ngClass]="sharedService.isMobile ? 'thread-content-mobile' : 'thread-content'">

        <!-- Main message section -->

        <div class="message-main" [ngClass]="{'current-user':userService.isCurrentUser(message!.user, userId)}">
            <img [src]="userService.getAvatarForUser(message.user)" alt="Avatar" class="avatar">
            <div class="message-content" *ngIf="!message.isEditing"
                [ngClass]="{'a-flex': userService.isCurrentUser(message.user, userId)}">
                <div class="name-time" [ngClass]="{'current-user': userService.isCurrentUser(message!.user, userId)}">
                    {{ message.user }}
                    <p class="time">{{ message.formatTimestamp() }}</p>
                </div>
                <div class="speech-bubble"
                    [ngClass]="{'border-radius': userService.isCurrentUser(message.user, userId)}">
                    {{ message.text }}
                    <div *ngIf="message.fileUrl" class="fileUrl">
                        <!-- Image Preview -->
                        <div *ngIf="message.fileType?.startsWith('image/')">
                            <img [src]="getSafeUrl(message.fileUrl)" alt="Image Preview"
                                style="width: 70px; height: auto; object-fit: contain;">
                        </div>
                        <!-- PDF Preview -->
                        <div *ngIf="message.fileType === 'application/pdf'">
                            <iframe [src]="getSafeUrl(message.fileUrl)" width="200" height="70px"
                                style="border: none;"></iframe>
                        </div>
                        <!-- Other File Types -->
                        <div *ngIf="!message.fileType?.startsWith('image/') && message.fileType != 'application/pdf'">
                            {{message.fileName}}</div>
                        <!-- Download Link -->
                        <a [href]="getSafeUrl(message.fileUrl)" class="open-file-button" target="_blank">Anhang
                            Ã¶ffnen</a>
                    </div>
                </div>
                <div style="display: flex;align-items: center;gap: 8px;">
                    <div *ngFor="let emojiData of message.emojis">
                        <span class="emoji-container"
                            *ngIf="emojiData && emojiData.userIds && emojiData.userIds.length > 0"
                            (click)="toggleEmojiReaction(message, emojiData)">
                            <img [src]="getEmojiSrc(emojiData.emoji)" [alt]="emojiData.emoji" />
                            <span>{{ emojiData.userIds.length }}</span>
                            <div class="emoji-tooltip"
                                *ngIf="emojiData && emojiData.userIds && emojiData.userIds.length > 0">
                                <span style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                    <img [src]="getEmojiSrc(emojiData.emoji)" [alt]="emojiData.emoji" width="30px" />
                                    <span class="emoji-reaction-text">
                                        {{ getEmojiReactionText(emojiData) }}
                                    </span>
                                    <span style="font-size: 16px; font-weight: 400;text-align: center;"> {{
                                        emojiData.userIds.length > 1 ? 'haben reagiert' : 'hat reagiert' }}</span>
                                </span>
                            </div>
                        </span>
                    </div>
                </div>
            </div>
            <div class="reaction-hover" *ngIf="!message.isEditing"
                [ngClass]="{'reaction-left': userService.isCurrentUser(message.user, userId)}">
                <img src="./assets/icons/add_reaction.png" alt="" (click)="toggleShowEmoji()">
                <div *ngIf="showEmoji" style="display: flex;">
                    <img src="./assets/icons/emoji _nerd face_.png" alt="nerd face"
                        (click)="toggleUserEmoji(message, 'nerd face', userId)" />
                    <img src="./assets/icons/ðŸ¦† emoji _person raising both hands in celebration_.png"
                        alt="raising both hands" (click)="toggleUserEmoji(message, 'raising both hands', userId)" />
                    <img src="./assets/icons/emoji _white heavy check mark_.png" alt="heavy check mark"
                        (click)="toggleUserEmoji(message, 'heavy check mark', userId)" />
                    <img src="./assets/icons/emoji _rocket_.png" alt="rocket"
                        (click)="toggleUserEmoji(message, 'rocket', userId)" />

                </div>
            </div>
            <div *ngIf="message.isEditing" class="textAreaContainer">
                <textarea [(ngModel)]="message.editedText" class="textEditingArea">
                </textarea>
                <div class="button-icons-group">
                    <div class="button-group">
                        <button class="cancelBtn" >Abbrechen</button>
                        <button class="saveBtn" >Speichern</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Separator and answer count -->
        <div class="separator">
            <p class="label-answers" *ngIf="selectedAnswers.length > 0">
                {{ selectedAnswers.length }} Antworten
            </p>
            <hr>
        </div>

        <!-- Answer list -->
        <div class="message-main" [ngClass]="{'current-user': userService.isCurrentUser(answer.user,userId)}"
            *ngFor="let answer of filteredSearchAnswers">
            <img [src]="userService.getAvatarForUser(answer.user)" alt="Avatar" class="avatar">
            <div class="message-content" *ngIf="!answer.isEditing"
                [ngClass]="{'a-flex': userService.isCurrentUser(answer.user,userId)}">
                <div class="name-time" [ngClass]="{'current-user': userService.isCurrentUser(answer.user,userId)}">
                    {{ answer.user }}
                    <p class="time">{{ answer.formatTimestamp() }}</p>
                </div>
                <div class="speech-bubble"
                    [ngClass]="{'border-radius': userService.isCurrentUser(answer.user, userId)}">

                    <div style="display: flex;flex-direction: column;gap: 20px;">
                        {{ answer.text }}
                        <div *ngIf="answer.fileUrl" class="fileUrl">
                            <!-- Image Preview -->
                            <div *ngIf="answer.fileType?.startsWith('image/')">
                                <img [src]="getSafeUrl(answer.fileUrl)" alt="Image Preview"
                                    style="width: 70px; height: auto; object-fit: contain;">
                            </div>
                            <!-- PDF Preview -->
                            <div *ngIf="answer.fileType === 'application/pdf'">
                                <iframe [src]="getSafeUrl(answer.fileUrl)" width="200" height="70px"
                                    style="border: none;"></iframe>
                            </div>
                            <!-- Other File Types -->
                            <div *ngIf="!answer.fileType?.startsWith('image/') && answer.fileType != 'application/pdf'">
                                {{answer.fileName}}</div>
                            <!-- Download Link -->
                            <a [href]="getSafeUrl(answer.fileUrl)" class="open-file-button" target="_blank">Anhang
                                Ã¶ffnen</a>
                        </div>
                    </div>
                </div>
                <div style="display: flex;align-items: center;gap: 8px;">
                    <div *ngFor="let emojiData of answer.emojis">
                        <span class="emoji-container"
                            *ngIf="emojiData && emojiData.userIds && emojiData.userIds.length > 0"
                            (click)="toggleEmojiReactionForAnswer(answer, emojiData)">
                            <img [src]="getEmojiSrc(emojiData.emoji)" [alt]="emojiData.emoji" />
                            <span>{{ emojiData.userIds.length }}</span>
                            <div class="emoji-tooltip"
                                *ngIf="emojiData && emojiData.userIds && emojiData.userIds.length > 0">
                                <span style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                    <img [src]="getEmojiSrc(emojiData.emoji)" [alt]="emojiData.emoji" width="30px" />
                                    <span class="emoji-reaction-text">
                                        {{ getEmojiReactionText(emojiData) }}
                                    </span>
                                    <span style="font-size: 16px; font-weight: 400;text-align: center;"> {{
                                        emojiData.userIds.length > 1 ? 'haben reagiert' : 'hat reagiert' }}</span>
                                </span>
                            </div>
                        </span>
                    </div>
                </div>
            </div>

            <div class="reaction-hover" *ngIf="!answer.isEditing"
                [ngClass]="{'reaction-left': userService.isCurrentUser(answer.user, userId)}">
                <img src="./assets/icons/add_reaction.png" alt="" (click)="toggleEmojitoAnswer()">
                <img src="./assets/icons/more_vert.png" alt="" *ngIf="userService.isCurrentUser(answer.user, userId)"
                    (click)="answersService.editDirectAnswer(answer)">
                <div *ngIf="showAnswerEmoji" style="display: flex;">
                    <img src="./assets/icons/emoji _nerd face_.png" alt="nerd face"
                        (click)="toggleUserEmojiAnswer(answer, 'nerd face', userId)" />
                    <img src="./assets/icons/ðŸ¦† emoji _person raising both hands in celebration_.png"
                        alt="raising both hands"
                        (click)="toggleUserEmojiAnswer(answer, 'raising both hands', userId)" />
                    <img src="./assets/icons/emoji _white heavy check mark_.png" alt="heavy check mark"
                        (click)="toggleUserEmojiAnswer(answer, 'heavy check mark', userId)" />
                    <img src="./assets/icons/emoji _rocket_.png" alt="rocket"
                        (click)="toggleUserEmojiAnswer(answer, 'rocket', userId)" />
                </div>
            </div>
            <div *ngIf="answer.isEditing" class="textAreaContainer">
                <textarea [(ngModel)]="answer.editedText" class="textEditingArea">
                </textarea>
                <div class="button-icons-group">
                    <div class="button-group">
                        <button class="cancelBtn" (click)="cancelEditAnswer(answer)">Abbrechen</button>
                        <button class="saveBtn" (click)="saveEditAnswer(answer)">Speichern</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input for new answers -->

        <div class="custom-input">

            <textarea placeholder="Antworten..." class="text-area" [(ngModel)]="newAnswerText"></textarea>

            <div *ngIf="selectedFile" class="selectedFileStyle">
                <!-- Datei-Vorschau fÃ¼r Bilder -->
                <div *ngIf="selectedFile.type.startsWith('image/') && fileUrl" class="file-preview"
                    style="display: flex; align-items: center; flex-direction: column;">
                    <img [src]="fileUrl" alt="Image Preview" style="max-width: 100px; max-height: 100px;">
                </div>

                <!-- Datei-Vorschau fÃ¼r PDFs -->
                <div *ngIf="selectedFile.type === 'application/pdf' && fileUrl"
                    style="display: flex; align-items: center; flex-direction: column;">
                    <iframe [src]="fileUrl" width="200" height="200" style="border: none;"></iframe>
                </div>

                <!-- Anzeige fÃ¼r andere Dateitypen -->
                <div *ngIf="!fileUrl || (!selectedFile.type.startsWith('image/') && selectedFile.type !== 'application/pdf')"
                    style="display: flex; align-items: center; flex-direction: column;">
                    <p>{{ selectedFile.name }}</p>
                </div>

                <!-- SchlieÃŸen-Button fÃ¼r Datei-Vorschau -->
                <img src="./../../../assets/icons/close.png" alt="Close" class="close-icon" (click)="closePreview()"
                    style="cursor: pointer;">
            </div>


            <div class="add-reaction">
                <div class="reactions">
                    <img src="./assets/icons/add-1.png" alt="Add" class="add-icon" (click)="fileInput.click()">
                    <input type="file" #fileInput style="display: none" (change)="onFileSelected($event)">
                    <div style="height: 50px; width: 1px; background-color: rgba(104, 104, 104, 1);"></div>
                    <img src="./assets/icons/sentiment_satisfied-1.png" alt="Emoji" class="add-emoji"
                        (click)="toggleEmojiPicker($event)">
                    <img src="./assets/icons/alternate_email-1.png" alt="Email" class="add-mail"
                        (click)="toggleAutoListe($event)">
                </div>
                <emoji-mart *ngIf="showEmojiPicker" (emojiSelect)="addEmoji($event)" class="emoji-picker"></emoji-mart>
                <img src="./assets/icons/Send icon.png" alt="Send" class="send-icon"
                    (click)="addAnswer(message!.messageId)">
            </div>

            <div *ngIf="taggedUser" class="tagged-user-list">
                <ul class="searchListe">
                    <li *ngFor="let user of userService.userData">
                        <div class="selectedUser" (click)="selectUser(user)">
                            <img [src]="userService.getAvatarForUser(user.name)" alt="">
                            {{user.name}}
                        </div>
                    </li>
                </ul>
            </div>
        </div>


    </div>


</div>